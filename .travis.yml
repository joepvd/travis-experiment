language: generic
dist: trusty
jobs:
    include:
        - stage: collect_the_evidence
          env: filter=true image=sudo-trusty
          sudo: required
          dist: trusty
        - env: filter=false image=sudo-trusty
          sudo: required
          dist: trusty
          filter_secrets: false
        - env: filter=true image=container-trusty
          sudo: false
          dist: trusty
        - env: filter=false image=container-trusty
          sudo: false
          dist: trusty
          filter_secrets: false
        - stage: report
          script:
              - |
                  for job in $(
                    curl --silent \
                        -H "Travis-API-Version: 3" \
                        -H "User-Agent: API Explorer" \
                        https://api.travis-ci.org/build/$TRAVIS_BUILD_ID \
                    | jq '.jobs[].id')
                  do
                    [[ $job = $TRAVIS_JOB_ID ]] && continue
                    curl -L https://api.travis-ci.org/jobs/$job/log.txt >$job.log
                  done
              - |
                  f() {
                      grep -E '^(stty:|stty --save|shopt:\$-:)' $1
                  }
              -   report() {
                      diff --side-by-side --width 100 <(f ${jobs[$1]}) <(f ${jobs[$2]})
                  }
              - jobs=( [0-9]*.log )
              - echo ${jobs[@]}
              - ls -l
              - report 0 1
              - report 0 2
              - report 0 3
              - report 1 2
              - report 1 3
              - report 2 3
install: true
script:
    - |
        stty --all \
        |   awk '
            BEGIN{ RS=";[ \n]?";FS=" (= )?" }
            NF<4{print "stty:"$0; next}
            {for(i=1;i<=NF;i++)print "stty:"$i}' \
        |   sort
    - echo stty --save $(stty --save)
    - printf "shopt:%s %s\n" $(shopt | sort)
    - shopt
    - echo $- | awk -F '' '{for(i=1;i<=NF;i++)print "$-":$i}' | sort
    - echo $-
notifications:
    email: false
