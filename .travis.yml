sudo: false
dist: trusty
language: generic
install:
    - |
        autocancel_state() {
            setting="$(
                curl 'https://api.travis-ci.org/repo/9293083/setting/auto_cancel_pushes' \
                -H 'Pragma: no-cache' \
                -H 'Origin: https://travis-ci.org' \
                -H 'Accept-Language: en-US,en;q=0.8,de;q=0.6,nl;q=0.4' \
                -H 'Travis-API-Version: 3' \
                -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36' \ 
                -H 'Content-Type: application/json; charset=UTF-8' \
                -H 'Accept: application/json; version=2' \
                -H 'Cache-Control: no-cache' \
                -H "Authorization: token $TRAVIS_TOKEN" \
                -H 'Connection: keep-alive' \
                -H 'Referer: https://travis-ci.org/joepvd/travis-experiment/settings' \
                | jq '[.name, .value|tostring ] | join(": ")'
            )"
            echo $setting
            if [[ $setting =~ true ]]
            then return 0
            else return 1
            fi
        }
        set_autocancel_push() {
            curl 'https://api.travis-ci.org/repo/9293083/setting/auto_cancel_pushes' \
                -X PATCH -H 'Pragma: no-cache' \
                -H 'Origin: https://travis-ci.org' \
                -H 'Accept-Language: en-US,en;q=0.8,de;q=0.6,nl;q=0.4' \
                -H 'Travis-API-Version: 3' \
                -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36' \
                -H 'Content-Type: application/json; charset=UTF-8' \
                -H 'Accept: application/json; version=2' \
                -H 'Cache-Control: no-cache' \
                -H "Authorization: token $TRAVIS_TOKEN" \
                -H 'Connection: keep-alive' \
                -H 'Referer: https://travis-ci.org/joepvd/travis-experiment/settings' \
                --data-binary '{"setting.value":true}'
        }
        set_variable() {
                curl 'https://api.travis-ci.org/settings/env_vars?repository_id=9293083' \
                -X PATCH -H 'Pragma: no-cache' \
                -H 'Origin: https://travis-ci.org' \
                -H 'Accept-Language: en-US,en;q=0.8,de;q=0.6,nl;q=0.4' \
                -H 'Travis-API-Version: 3' \
                -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36' \
                -H 'Content-Type: application/json; charset=UTF-8' \
                -H 'Accept: application/json; version=2' \
                -H 'Cache-Control: no-cache' \
                -H "Authorization: token $TRAVIS_TOKEN" \
                -H 'Connection: keep-alive' \
                -H 'Referer: https://travis-ci.org/joepvd/travis-experiment/settings' \
                --data-binary '{"env_var":{"name":"test","value":"test","public":false,"repository_id":"9293083"}}'
        }
        delete_if_present() {
            if curl 'https://api.travis-ci.org/settings/env_vars?repository_id=9293083' \
                -H 'Pragma: no-cache' \
                -H 'Origin: https://travis-ci.org' \
                -H 'Accept-Language: en-US,en;q=0.8,de;q=0.6,nl;q=0.4' \
                -H 'Travis-API-Version: 3' \
                -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36' \ 
                -H 'Content-Type: application/json; charset=UTF-8' \
                -H 'Accept: application/json; version=2' \
                -H 'Cache-Control: no-cache' \
                -H "Authorization: token $TRAVIS_TOKEN" \
                -H 'Connection: keep-alive' \
                -H 'Referer: https://travis-ci.org/joepvd/travis-experiment/settings' \
                | jq '.env_vars[].name' | grep -x '"test"'
            then curl 'https://api.travis-ci.org/settings/env_vars/947b82c4-e8ef-4840-a494-07b406659e56?repository_id=9293083' \
                -X DELETE \
                -H 'Pragma: no-cache' \
                -H 'Origin: https://travis-ci.org' \
                -H 'Accept-Language: en-US,en;q=0.8,de;q=0.6,nl;q=0.4' \
                -H 'Travis-API-Version: 3' \
                -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36' \ 
                -H 'Content-Type: application/json; charset=UTF-8' \
                -H 'Accept: application/json; version=2' \
                -H 'Cache-Control: no-cache' \
                -H "Authorization: token $TRAVIS_TOKEN" \
                -H 'Connection: keep-alive' \
                -H 'Referer: https://travis-ci.org/joepvd/travis-experiment/settings'
            fi
        }
script:
    - autocancel_state
    - sleep 1; set_autocancel_push
    - sleep 1; autocancel_state
    - delete_if_present
    - sleep 1; set_variable
    - sleep 1; autocancel_state
notifications:
    email: false
