
language: bash
matrix:
    include:
        - env: test=ssh-agent filter=true image=container-trusty
          sudo: false
          dist: trusty
          install: eval `ssh-agent -s`
        - env: filter=false image=container-trusty
          sudo: false
          dist: trusty
          filter_secrets: false
          install: eval `ssh-agent -s`
        - env: test=sleep filter=true image=container-trusty
          sudo: false
          dist: trusty
          install: "setsid sh -c 'sleep 1000' &"
        - env: test=sleep filter=false image=container-trusty
          sudo: false
          dist: trusty
          filter_secrets: false
          install: "setsid sh -c 'sleep 1000' &"

install:
script:
    - sleep 1
    - echo $$
    - pgrep ssh-agent
    - ls -l /proc/$$/fd
    - ps -jef --forest 2>/dev/null || ps -jef
    - "pkill -9 -P $$ || true"
    - sleep 1
    - ps -jef --forest 2>/dev/null || ps -jef
    - '[[ "$TRAVIS_FILTERED" = redirect_io && -e /dev/fd/9 ]] && sync && command exec 1>&9 2>&9 9>&- && sync'
    - if [ -f /.dockerenv ]; then kill -9 $(awk -v pid=$$ '$1!=pid' <(ps --no-headers --user $USER -opid:1)); else pkill -9 -P $$; fi
    - "pgrep ssh-agent && false || true"
    - ps -jef --forest 2>/dev/null || ps -jef
      #- |
      #-   stty --all \
      #-   | awk '
      #-         BEGIN{ RS=";[ \n]?"; FS=" (= )?|\n"; OFS=":" }
      #-         NF<4{print "stty:"$0; next}
      #-         {for(i=1;$i!="";i++){bool = sub(/^-/, "", $i); print "stty",$i,bool}}' \
      #-   | sort
      #- printf "shopt:%s %s\n" $(shopt | sort)
      #- echo $- | awk -F '' '{for(i=1;i<=NF;i++)print "$-:"$i}' | sort

notifications:
    email: never
