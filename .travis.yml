
language: bash
sudo: false
dist: trusty
install:
    - eval `ssh-agent -s`
    - "setsid sh -c sleep 1000 &"
    - sleep 1
script:
    - pgrep ssh-agent
    - ls -l /proc/$$/fd
    - ps -jef --forest
    - |
        travis_terminate() {
          set +e
          # Restoring the file descriptors of redirect_io filter strategy
          [[ "$TRAVIS_FILTERED" = redirect_io && -e /dev/fd/9 ]] \
              && sync \
              && command exec 1>&9 2>&9 9>&- \
              && sync
          #pkill -9 -P $$ &> /dev/null || true
          kill -9 $(awk -v pid=$$ '$1!=pid' <(ps --no-headers --user $USER -opid:1))
          #exit $1
        }
    - "pgrep ssh-agent && false || true"
    - ps -jef --forest
    - exit
notifications:
    email: never
